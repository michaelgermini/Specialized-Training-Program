<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©thode Fran√ßais-Tha√Ø Moderne</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            margin: 10px;
        }
        .controls {
            margin-bottom: 30px;
            text-align: center;
        }
        .controls button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            transition: background 0.3s;
        }
        .controls button:hover {
            background: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .language-cell {
            padding: 10px;
            min-width: 120px;
        }
        .text-with-audio {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .text-content {
            font-weight: 500;
            text-align: center;
        }
        audio {
            width: 100px;
            height: 25px;
            border-radius: 3px;
        }
        .audio-row {
            display: flex;
            justify-content: center;
            margin-top: 5px;
        }
        .phonetic {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .phonetic-highlight {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 4px;
            padding: 2px 6px;
            color: #856404;
            font-weight: bold;
            animation: phonetic-glow 1.5s infinite alternate;
        }

        .chinese-highlight {
            background: linear-gradient(45deg, #a29bfe, #fd79a8);
            border: 2px solid #6c5ce7;
            border-radius: 4px;
            padding: 2px 6px;
            color: white !important;
            font-weight: bold;
            animation: chinese-glow 1.5s infinite alternate;
        }

        .pinyin-highlight {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            border: 2px solid #d63031;
            border-radius: 4px;
            padding: 2px 6px;
            color: #2d3436 !important;
            font-weight: bold;
            animation: pinyin-glow 1.5s infinite alternate;
        }

        .language-highlight {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            border: 2px solid #0984e3;
            border-radius: 4px;
            padding: 2px 6px;
            color: white !important;
            font-weight: bold;
            animation: language-glow 1.5s infinite alternate;
        }
        @keyframes phonetic-glow {
            0% {
                background-color: #fff3cd;
                box-shadow: 0 0 5px #ffc107;
            }
            100% {
                background-color: #ffeaa7;
                box-shadow: 0 0 15px #ffc107;
            }
        }

        @keyframes chinese-glow {
            0% {
                background: linear-gradient(45deg, #a29bfe, #fd79a8);
                box-shadow: 0 0 5px #6c5ce7;
            }
            100% {
                background: linear-gradient(45deg, #fd79a8, #a29bfe);
                box-shadow: 0 0 15px #6c5ce7;
            }
        }

        @keyframes pinyin-glow {
            0% {
                background: linear-gradient(45deg, #fdcb6e, #e17055);
                box-shadow: 0 0 5px #d63031;
            }
            100% {
                background: linear-gradient(45deg, #e17055, #fdcb6e);
                box-shadow: 0 0 15px #d63031;
            }
        }

        @keyframes language-glow {
            0% {
                background: linear-gradient(45deg, #74b9ff, #0984e3);
                box-shadow: 0 0 5px #0984e3;
            }
            100% {
                background: linear-gradient(45deg, #0984e3, #74b9ff);
                box-shadow: 0 0 15px #0984e3;
            }
        }
        .audio-playing {
            background-color: #f8f9ff !important;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        .playing-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
            animation: playing-pulse 2s infinite;
        }
        @keyframes playing-pulse {
            0%, 100% { background-color: #fff3cd; }
            50% { background-color: #ffeaa7; }
        }
        .thai-text {
            font-size: 1.1em;
            color: #e74c3c;
        }
        .chinese-text {
            font-size: 1.2em;
            color: #d63031;
            font-family: 'Microsoft YaHei', 'SimSun', 'Arial Unicode MS', sans-serif;
        }
        .pinyin {
            font-style: italic;
            color: #636e72;
            font-size: 0.85em;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #e9ecef;
        }
        .english-text {
            font-size: 1.1em;
            color: #6c757d;
        }
        .german-text {
            font-size: 1.1em;
            color: #dc3545;
        }
        .spanish-text {
            font-size: 1.1em;
            color: #fd7e14;
        }
        .italian-text {
            font-size: 1.1em;
            color: #20c997;
        }
        .category-filter {
            margin-bottom: 20px;
            text-align: center;
        }
        .category-filter select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        .filters-section {
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .language-filter {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        .language-filter label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }
        .language-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        .checkbox-label:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        .checkbox-label input[type="checkbox"] {
            display: none;
        }
        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-radius: 3px;
            margin-right: 8px;
            position: relative;
            transition: all 0.3s ease;
            background: white;
        }
        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: #3498db;
            border-color: #3498db;
        }
        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: '‚úì';
            position: absolute;
            top: -2px;
            left: 2px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .reset-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .reset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
        }
        /* Masquer les colonnes de langues non s√©lectionn√©es */
        .lang-fr.hidden, .lang-en.hidden, .lang-de.hidden,
        .lang-es.hidden, .lang-it.hidden, .lang-th.hidden, .lang-zh.hidden,
        .lang-phon.hidden, .lang-pinyin.hidden {
            display: none;
        }
        /* Masquer les en-t√™tes correspondants */
        th[data-lang="fr"].hidden, th[data-lang="en"].hidden, th[data-lang="de"].hidden,
        th[data-lang="es"].hidden, th[data-lang="it"].hidden, th[data-lang="th"].hidden,
        th[data-lang="zh"].hidden, th[data-lang="phon"].hidden, th[data-lang="pinyin"].hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .progress {
            margin-bottom: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        .category-playback {
            margin-bottom: 30px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        .category-playback h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        .playback-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .playback-buttons button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        .playback-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö M√©thode Fran√ßais‚ÄìTha√Ø Moderne</h1>

        <div class="stats">
            <div class="stat-card">
                <h3>{{ entries|length }}</h3>
                <p>Mots/Phrases</p>
            </div>
            <div class="stat-card">
                <h3>5</h3>
                <p>Cat√©gories</p>
            </div>
            <div class="stat-card">
                <h3>80%</h3>
                <p>Couverture Conversation</p>
            </div>
        </div>

        <div class="controls">
            <button onclick="generateAllAudios()">üîä G√©n√©rer Tous les Audios</button>
            <button onclick="regenerateMissingAudios()">üîÑ R√©g√©n√©rer Audios Manquants</button>
            <button onclick="playAllAudios()">‚ñ∂Ô∏è Tout √âcouter</button>
            <button onclick="stopPlayback()" id="stopButton" style="display: none;">‚èπÔ∏è Arr√™ter</button>
            <button onclick="downloadLexique()">üì• T√©l√©charger CSV</button>
        </div>

        <div class="category-playback">
            <h3>üéµ √âcouter par Cat√©gorie</h3>
            <div class="playback-buttons">
                <button onclick="playAllAudios('noyau')">üü¢ Noyau (Base & Survie)</button>
                <button onclick="playAllAudios('quotidien')">üîµ Quotidien</button>
                <button onclick="playAllAudios('social')">üü£ Social</button>
                <button onclick="playAllAudios('travail')">üü† Travail & √âtudes</button>
                <button onclick="playAllAudios('special')">üî¥ Situations Sp√©ciales</button>
            </div>
        </div>

        <div class="filters-section">
            <div class="category-filter">
                <label for="category">üìÇ Filtrer par cat√©gorie:</label>
                <select id="category" onchange="filterByCategory()">
                    <option value="all">Toutes les cat√©gories</option>
                    <option value="noyau">üîπ Noyau (Base & Survie)</option>
                    <option value="quotidien">üîµ Quotidien</option>
                    <option value="social">üü£ Vie Sociale</option>
                    <option value="travail">üü† Travail & √âtudes</option>
                    <option value="special">üî¥ Situations Sp√©ciales</option>
                </select>
            </div>

            <div class="language-filter">
                <label>üåê Langues √† afficher:</label>
                <div class="language-checkboxes">
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-fr" checked onchange="toggleLanguage('fr')">
                        <span class="checkmark"></span>
                        üá´üá∑ Fran√ßais
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-en" checked onchange="toggleLanguage('en')">
                        <span class="checkmark"></span>
                        üá∫üá∏ Anglais
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-de" checked onchange="toggleLanguage('de')">
                        <span class="checkmark"></span>
                        üá©üá™ Allemand
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-es" checked onchange="toggleLanguage('es')">
                        <span class="checkmark"></span>
                        üá™üá∏ Espagnol
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-it" checked onchange="toggleLanguage('it')">
                        <span class="checkmark"></span>
                        üáÆüáπ Italien
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-th" checked onchange="toggleLanguage('th')">
                        <span class="checkmark"></span>
                        üáπüá≠ Tha√Ø
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-zh" checked onchange="toggleLanguage('zh')">
                        <span class="checkmark"></span>
                        üá®üá≥ Chinois
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-phon" checked onchange="toggleLanguage('phon')">
                        <span class="checkmark"></span>
                        üî§ Phon√©tique
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="lang-pinyin" checked onchange="toggleLanguage('pinyin')">
                        <span class="checkmark"></span>
                        üó£Ô∏è Pinyin
                    </label>
                </div>
                <button onclick="resetLanguageSelection()" class="reset-btn">üîÑ R√©initialiser</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <p>G√©n√©ration des audios en cours...</p>
            <div class="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <table id="lexiqueTable">
            <thead>
                <tr>
                    <th data-lang="fr">Fran√ßais</th>
                    <th data-lang="en">Anglais</th>
                    <th data-lang="de">Allemand</th>
                    <th data-lang="es">Espagnol</th>
                    <th data-lang="it">Italien</th>
                    <th data-lang="th">Tha√Ø</th>
                    <th data-lang="zh">Chinois</th>
                    <th data-lang="phon">Phon√©tique</th>
                    <th data-lang="pinyin">Pinyin</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr data-category="{{ entry.category or 'other' }}">
                    <td class="language-cell lang-fr">
                        <div class="text-with-audio">
                            <div class="text-content">{{ entry.fr }}</div>
                            <div class="audio-row">
                                <audio controls preload="none">
                                    <source src="{{ url_for('serve_audio', filename=entry.fr_audio) }}" type="audio/mpeg">
                                    Votre navigateur ne supporte pas l'audio.
                                </audio>
                            </div>
                        </div>
                    </td>
                    <td class="language-cell lang-en">
                        <div class="text-with-audio">
                            <div class="text-content english-text">{{ entry.get('en', '-') }}</div>
                            {% if entry.get('en_audio') %}
                            <div class="audio-row">
                                <audio controls preload="none">
                                    <source src="{{ url_for('serve_audio', filename=entry.en_audio) }}" type="audio/mpeg">
                                    Votre navigateur ne supporte pas l'audio.
                                </audio>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="language-cell lang-de">
                        <div class="text-with-audio">
                            <div class="text-content german-text">{{ entry.get('de', '-') }}</div>
                            {% if entry.get('de_audio') %}
                            <div class="audio-row">
                                <audio controls preload="none">
                                    <source src="{{ url_for('serve_audio', filename=entry.de_audio) }}" type="audio/mpeg">
                                    Votre navigateur ne supporte pas l'audio.
                                </audio>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="language-cell lang-es">
                        <div class="text-with-audio">
                            <div class="text-content spanish-text">{{ entry.get('es', '-') }}</div>
                            {% if entry.get('es_audio') %}
                            <div class="audio-row">
                                <audio controls preload="none">
                                    <source src="{{ url_for('serve_audio', filename=entry.es_audio) }}" type="audio/mpeg">
                                    Votre navigateur ne supporte pas l'audio.
                                </audio>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="language-cell lang-it">
                        <div class="text-with-audio">
                            <div class="text-content italian-text">{{ entry.get('it', '-') }}</div>
                            {% if entry.get('it_audio') %}
                            <div class="audio-row">
                                <audio controls preload="none">
                                    <source src="{{ url_for('serve_audio', filename=entry.it_audio) }}" type="audio/mpeg">
                                    Votre navigateur ne supporte pas l'audio.
                                </audio>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="language-cell lang-th">
                        <div class="text-with-audio">
                            <div class="text-content thai-text">{{ entry.th }}</div>
                            <div class="audio-row">
                                <audio controls preload="none">
                                    <source src="{{ url_for('serve_audio', filename=entry.th_audio) }}" type="audio/mpeg">
                                    Votre navigateur ne supporte pas l'audio.
                                </audio>
                            </div>
                        </div>
                    </td>
                    <td class="language-cell lang-zh">
                        <div class="text-with-audio">
                            <div class="text-content chinese-text">{{ entry.get('zh', '-') }}</div>
                            {% if entry.get('zh_audio') %}
                            <div class="audio-row">
                                <audio controls preload="none">
                                    <source src="{{ url_for('serve_audio', filename=entry.zh_audio) }}" type="audio/mpeg">
                                    Votre navigateur ne supporte pas l'audio.
                                </audio>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="language-cell lang-phon">
                        <div class="text-content phonetic" id="phonetic-{{ loop.index }}">{{ entry.phon }}</div>
                    </td>
                    <td class="language-cell lang-pinyin">
                        <div class="text-content pinyin">{{ entry.get('pinyin', '-') }}</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        let allAudios = [];
        let currentAudioIndex = 0;

        function generateAllAudios() {
            const loading = document.getElementById('loading');
            const progressFill = document.getElementById('progressFill');
            loading.style.display = 'block';

            // R√©cup√©rer tous les √©l√©ments audio
            allAudios = Array.from(document.querySelectorAll('audio'));
            let completed = 0;

            allAudios.forEach((audio, index) => {
                // Simuler la g√©n√©ration (en r√©alit√©, les audios sont d√©j√† g√©n√©r√©s c√¥t√© serveur)
                setTimeout(() => {
                    completed++;
                    const progress = (completed / allAudios.length) * 100;
                    progressFill.style.width = progress + '%';

                    if (completed === allAudios.length) {
                        loading.style.display = 'none';
                        alert('Tous les audios ont √©t√© g√©n√©r√©s !');
                    }
                }, index * 100);
            });
        }

        async function regenerateMissingAudios() {
            const loading = document.getElementById('loading');
            const progressFill = document.getElementById('progressFill');
            loading.style.display = 'block';

            const audioElements = document.querySelectorAll('audio');
            let processed = 0;
            let regenerated = 0;

            for (const audio of audioElements) {
                try {
                    // Essayer de charger l'audio pour voir s'il existe
                    await new Promise((resolve, reject) => {
                        const testAudio = new Audio(audio.src);
                        testAudio.addEventListener('loadeddata', resolve);
                        testAudio.addEventListener('error', reject);
                        // Timeout apr√®s 2 secondes
                        setTimeout(reject, 2000);
                    });
                } catch (error) {
                    // L'audio n'existe pas ou n'est pas accessible, r√©g√©n√©rer
                    console.log(`üîÑ R√©g√©n√©ration n√©cessaire pour: ${audio.src}`);

                    // Trouver le texte et la langue
                    const rowElement = audio.closest('tr');
                    const cells = rowElement.querySelectorAll('td');
                    let text = '';
                    let lang = '';

                    // D√©terminer la langue selon la colonne
                    const cellIndex = Array.from(audio.closest('.language-cell').parentElement.children).indexOf(audio.closest('.language-cell'));
                    if (cellIndex === 0) {
                        text = cells[0].querySelector('.text-content').textContent;
                        lang = 'fr';
                    } else if (cellIndex === 1) {
                        text = cells[1].querySelector('.text-content').textContent;
                        lang = 'en';
                    } else if (cellIndex === 2) {
                        text = cells[2].querySelector('.text-content').textContent;
                        lang = 'de';
                    } else if (cellIndex === 3) {
                        text = cells[3].querySelector('.text-content').textContent;
                        lang = 'es';
                    } else if (cellIndex === 4) {
                        text = cells[4].querySelector('.text-content').textContent;
                        lang = 'it';
                    } else if (cellIndex === 5) {
                        text = cells[5].querySelector('.text-content').textContent;
                        lang = 'th';
                    } else if (cellIndex === 6) {
                        text = cells[6].querySelector('.text-content').textContent;
                        lang = 'zh';
                    }

                    if (text && lang) {
                        try {
                            const response = await fetch('/generate_audio', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ text: text, lang: lang })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                audio.src = `/static/audio/${data.filename}`;
                                audio.load();
                                regenerated++;
                                console.log(`‚úÖ Audio r√©g√©n√©r√©: ${text} (${lang})`);
                            }
                        } catch (fetchError) {
                            console.error(`‚ùå Erreur r√©g√©n√©ration: ${text} (${lang})`);
                        }
                    }
                }

                processed++;
                const progress = (processed / audioElements.length) * 100;
                progressFill.style.width = progress + '%';
            }

            loading.style.display = 'none';
            alert(`${regenerated} audios ont √©t√© r√©g√©n√©r√©s sur ${audioElements.length} contr√¥les audio v√©rifi√©s.`);
        }

        function playAllAudios(category = 'all') {
            // Obtenir les langues s√©lectionn√©es
            const selectedLanguages = getSelectedLanguages();

            // Filtrer les audios selon la cat√©gorie et les langues s√©lectionn√©es
            let allAudioElements;
            if (category === 'all') {
                allAudioElements = Array.from(document.querySelectorAll('audio'));
            } else {
                // Trouver tous les √©l√©ments audio dans les lignes de la cat√©gorie s√©lectionn√©e
                const categoryRows = document.querySelectorAll(`#lexiqueTable tbody tr[data-category="${category}"]`);
                allAudioElements = [];
                categoryRows.forEach(row => {
                    const audios = row.querySelectorAll('audio');
                    allAudioElements.push(...audios);
                });
            }

            // Filtrer selon les langues s√©lectionn√©es
            allAudioElements = allAudioElements.filter(audio => {
                const cell = audio.closest('.language-cell');
                if (!cell) return false;

                const langClass = Array.from(cell.classList).find(cls => cls.startsWith('lang-'));
                if (!langClass) return false;

                const lang = langClass.replace('lang-', '');
                return selectedLanguages.includes(lang);
            });

            allAudios = allAudioElements;
            currentAudioIndex = 0;

            if (allAudios.length === 0) {
                const categoryText = category === 'all' ? '' : ` dans la cat√©gorie "${category}"`;
                alert(`Aucun audio trouv√© pour les langues s√©lectionn√©es${categoryText}. V√©rifiez vos s√©lections de langues.`);
                return;
            }

            const langList = selectedLanguages.map(l => l.toUpperCase()).join(', ');
            const categoryText = category === 'all' ? '' : ` de la cat√©gorie "${category}"`;
            console.log(`üéµ Lecture de ${allAudios.length} audios${categoryText} pour les langues: ${langList}`);

            // Afficher le bouton stop et masquer les boutons play
            document.getElementById('stopButton').style.display = 'inline-block';
            document.querySelectorAll('.controls button:not(#stopButton)').forEach(btn => {
                if (btn.textContent.includes('‚ñ∂Ô∏è')) {
                    btn.style.display = 'none';
                }
            });

            playNextAudio();
        }

        // Obtenir la liste des langues s√©lectionn√©es
        function getSelectedLanguages() {
            const selectedLanguages = [];
            const languages = ['fr', 'en', 'de', 'es', 'it', 'th', 'zh', 'phon', 'pinyin'];

            languages.forEach(lang => {
                const checkbox = document.getElementById(`lang-${lang}`);
                if (checkbox && checkbox.checked) {
                    selectedLanguages.push(lang);
                }
            });

            return selectedLanguages;
        }

        function playNextAudio() {
            if (currentAudioIndex < allAudios.length) {
                const audio = allAudios[currentAudioIndex];

                // Afficher des informations sur l'audio en cours
                const rowElement = audio.closest('tr');
                const cells = rowElement.querySelectorAll('td');
                const frenchText = cells[0].querySelector('.text-content').textContent;
                const category = rowElement.dataset.category;

                console.log(`üéß Lecture audio ${currentAudioIndex + 1}/${allAudios.length}: "${frenchText}" (${category})`);

                // Mettre en √©vidence la ligne en cours de lecture
                document.querySelectorAll('#lexiqueTable tbody tr').forEach(row => {
                    row.classList.remove('playing-row');
                });
                rowElement.classList.add('playing-row');

                audio.play();
                audio.onended = () => {
                    currentAudioIndex++;
                    setTimeout(playNextAudio, 1000); // Pause de 1 seconde entre les audios
                };
            } else {
                // Retirer la mise en √©vidence et r√©afficher les boutons
                document.querySelectorAll('#lexiqueTable tbody tr').forEach(row => {
                    row.classList.remove('playing-row');
                });
                resetPlaybackButtons();
                alert('Lecture termin√©e ! üéâ');
            }
        }

        function stopPlayback() {
            // Arr√™ter tous les audios en cours
            if (allAudios && allAudios.length > 0) {
                allAudios.forEach(audio => {
                    audio.pause();
                    audio.currentTime = 0;
                });
            }

            // Retirer la mise en √©vidence
            document.querySelectorAll('#lexiqueTable tbody tr').forEach(row => {
                row.classList.remove('playing-row');
            });

            // R√©initialiser l'index
            currentAudioIndex = 0;

            // R√©afficher les boutons
            resetPlaybackButtons();

            console.log('‚èπÔ∏è Lecture arr√™t√©e par l\'utilisateur');
        }

        function resetPlaybackButtons() {
            // Masquer le bouton stop
            document.getElementById('stopButton').style.display = 'none';

            // R√©afficher tous les boutons play
            document.querySelectorAll('.controls button').forEach(btn => {
                btn.style.display = 'inline-block';
            });
        }

        function filterByCategory() {
            const category = document.getElementById('category').value;
            const rows = document.querySelectorAll('#lexiqueTable tbody tr');

            rows.forEach(row => {
                if (category === 'all' || row.dataset.category === category) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Gestionnaire pour basculer l'affichage d'une langue
        function toggleLanguage(lang) {
            const checkbox = document.getElementById(`lang-${lang}`);
            const isChecked = checkbox.checked;

            // Sauvegarder la pr√©f√©rence dans localStorage
            const preferences = JSON.parse(localStorage.getItem('languagePreferences') || '{}');
            preferences[lang] = isChecked;
            localStorage.setItem('languagePreferences', JSON.stringify(preferences));

            // Appliquer la visibilit√©
            updateLanguageVisibility();

            console.log(`${lang.toUpperCase()} ${isChecked ? 'affich√©' : 'masqu√©'}`);
        }

        // Mettre √† jour la visibilit√© des colonnes de langues
        function updateLanguageVisibility() {
            const languages = ['fr', 'en', 'de', 'es', 'it', 'th', 'zh', 'phon', 'pinyin'];

            languages.forEach(lang => {
                const checkbox = document.getElementById(`lang-${lang}`);
                const isVisible = checkbox.checked;

                // Masquer/afficher les cellules de donn√©es
                const cells = document.querySelectorAll(`.lang-${lang}`);
                cells.forEach(cell => {
                    if (isVisible) {
                        cell.classList.remove('hidden');
                    } else {
                        cell.classList.add('hidden');
                    }
                });

                // Masquer/afficher les en-t√™tes
                const headers = document.querySelectorAll(`th[data-lang="${lang}"]`);
                headers.forEach(header => {
                    if (isVisible) {
                        header.classList.remove('hidden');
                    } else {
                        header.classList.add('hidden');
                    }
                });
            });
        }

        // R√©initialiser la s√©lection des langues
        function resetLanguageSelection() {
            const languages = ['fr', 'en', 'de', 'es', 'it', 'th', 'zh', 'phon', 'pinyin'];

            // Cocher toutes les cases
            languages.forEach(lang => {
                const checkbox = document.getElementById(`lang-${lang}`);
                checkbox.checked = true;

                // Sauvegarder dans localStorage
                const preferences = JSON.parse(localStorage.getItem('languagePreferences') || '{}');
                preferences[lang] = true;
                localStorage.setItem('languagePreferences', JSON.stringify(preferences));
            });

            // Mettre √† jour l'affichage
            updateLanguageVisibility();

            console.log('‚úÖ Toutes les langues ont √©t√© r√©activ√©es');
        }

        // Charger les pr√©f√©rences depuis localStorage
        function loadLanguagePreferences() {
            const preferences = JSON.parse(localStorage.getItem('languagePreferences') || '{}');
            const languages = ['fr', 'en', 'de', 'es', 'it', 'th', 'zh', 'phon', 'pinyin'];

            languages.forEach(lang => {
                const checkbox = document.getElementById(`lang-${lang}`);
                const isChecked = preferences[lang] !== false; // Par d√©faut true si pas d√©fini
                checkbox.checked = isChecked;
            });

            // Appliquer la visibilit√©
            updateLanguageVisibility();
        }

        function downloadLexique() {
            // Cr√©er un lien de t√©l√©chargement pour le CSV
            const link = document.createElement('a');
            link.href = '/static/lexique.csv'; // On supposera que le CSV est servi statiquement
            link.download = 'lexique_francais_thai.csv';
            link.click();
        }

        // Les fonctions d'illumination sont maintenant int√©gr√©es directement dans les event listeners

        // Fonction pour r√©g√©n√©rer un audio manuellement
        async function regenerateAudio(audioElement, text, lang, filename) {
            try {
                const response = await fetch('/generate_audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        lang: lang
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // Mettre √† jour la source de l'audio
                    audioElement.src = `/static/audio/${data.filename}`;
                    audioElement.load(); // Recharger l'audio
                    console.log(`‚úÖ Audio r√©g√©n√©r√©: ${text} (${lang})`);
                } else {
                    console.error(`‚ùå Erreur r√©g√©n√©ration audio: ${text} (${lang})`);
                }
            } catch (error) {
                console.error(`‚ùå Erreur r√©seau: ${error}`);
            }
        }

        // Fonction pour g√©rer les √©v√©nements audio
        function setupAudioListeners() {
            const audioElements = document.querySelectorAll('audio');
            console.log(`üéµ Found ${audioElements.length} audio elements`);
            audioElements.forEach((audio, index) => {
                console.log(`üéµ Processing audio ${index + 1}/${audioElements.length}: ${audio.src}`);
                // Trouver la ligne parente pour identifier l'index
                let rowElement = audio.closest('tr');
                if (!rowElement) {
                    console.log(`‚ùå No row element found for audio ${index}`);
                    return;
                }
                console.log(`üéØ Found row element for audio ${index}`);

                let rowIndex = Array.from(rowElement.parentElement.children).indexOf(rowElement) + 1;

                // G√©rer les erreurs de chargement d'audio
                audio.addEventListener('error', function() {
                    console.log(`üîÑ R√©g√©n√©ration audio pour ligne ${rowIndex}`);
                    // Trouver le texte et la langue depuis la ligne
                    const cells = rowElement.querySelectorAll('td');
                    let text = '';
                    let lang = '';

                    // D√©terminer la langue selon la colonne
                    if (audio.closest('.language-cell')) {
                        const cellIndex = Array.from(audio.closest('.language-cell').parentElement.children).indexOf(audio.closest('.language-cell'));
                        if (cellIndex === 0) {
                            text = cells[0].querySelector('.text-content').textContent;
                            lang = 'fr';
                        } else if (cellIndex === 1) {
                            text = cells[1].querySelector('.text-content').textContent;
                            lang = 'en';
                        } else if (cellIndex === 2) {
                            text = cells[2].querySelector('.text-content').textContent;
                            lang = 'de';
                        } else if (cellIndex === 3) {
                            text = cells[3].querySelector('.text-content').textContent;
                            lang = 'es';
                        } else if (cellIndex === 4) {
                            text = cells[4].querySelector('.text-content').textContent;
                            lang = 'it';
                        } else if (cellIndex === 5) {
                            text = cells[5].querySelector('.text-content').textContent;
                            lang = 'th';
                        } else if (cellIndex === 6) {
                            text = cells[6].querySelector('.text-content').textContent;
                            lang = 'zh';
                        }
                    }

                    if (text && lang) {
                        regenerateAudio(audio, text, lang, audio.src.split('/').pop());
                    }
                });

                audio.addEventListener('play', function() {
                    // D√©tecter la langue de l'audio et illuminer le texte appropri√©
                    const audioFilename = audio.src.split('/').pop();
                    console.log('üéµ Audio playing:', audioFilename);
                    console.log('üéØ Row element:', rowElement);

                    // Illuminer le texte selon la langue de l'audio
                    if (audioFilename.startsWith('fr_')) {
                        // Audio fran√ßais : illuminer le texte fran√ßais
                        const frenchElement = rowElement.querySelector('.lang-fr .text-content');
                        if (frenchElement) {
                            frenchElement.classList.add('language-highlight');
                            console.log('‚úÖ French text highlighted');
                        }
                    } else if (audioFilename.startsWith('en_')) {
                        // Audio anglais : illuminer le texte anglais
                        const englishElement = rowElement.querySelector('.lang-en .text-content');
                        if (englishElement) {
                            englishElement.classList.add('language-highlight');
                            console.log('‚úÖ English text highlighted');
                        }
                    } else if (audioFilename.startsWith('de_')) {
                        // Audio allemand : illuminer le texte allemand
                        const germanElement = rowElement.querySelector('.lang-de .text-content');
                        if (germanElement) {
                            germanElement.classList.add('language-highlight');
                            console.log('‚úÖ German text highlighted');
                        }
                    } else if (audioFilename.startsWith('es_')) {
                        // Audio espagnol : illuminer le texte espagnol
                        const spanishElement = rowElement.querySelector('.lang-es .text-content');
                        if (spanishElement) {
                            spanishElement.classList.add('language-highlight');
                            console.log('‚úÖ Spanish text highlighted');
                        }
                    } else if (audioFilename.startsWith('it_')) {
                        // Audio italien : illuminer le texte italien
                        const italianElement = rowElement.querySelector('.lang-it .text-content');
                        if (italianElement) {
                            italianElement.classList.add('language-highlight');
                            console.log('‚úÖ Italian text highlighted');
                        }
                    } else if (audioFilename.startsWith('th_')) {
                        // Audio tha√Ø : illuminer la phon√©tique dans cette ligne
                        console.log('üîç Looking for Thai phonetic elements...');
                        const phoneticElement = rowElement.querySelector('.lang-phon .phonetic');
                        console.log('üîç Primary phonetic selector result:', phoneticElement);
                        if (phoneticElement) {
                            phoneticElement.classList.add('phonetic-highlight');
                            console.log('‚úÖ Tha√Ø phonetic highlighted');
                        } else {
                            // Essayer d'autres s√©lecteurs
                            const altPhonetic = rowElement.querySelector('.phonetic');
                            console.log('üîç Alternative phonetic selector result:', altPhonetic);
                            if (altPhonetic) {
                                altPhonetic.classList.add('phonetic-highlight');
                                console.log('‚úÖ Tha√Ø phonetic highlighted (alt selector)');
                            } else {
                                console.log('‚ùå No phonetic element found in row');
                            }
                        }
                    } else if (audioFilename.startsWith('zh_')) {
                        // Audio chinois : illuminer le texte chinois ET le pinyin
                        console.log('üîç Looking for Chinese text elements...');
                        const chineseElement = rowElement.querySelector('.lang-zh .chinese-text');
                        const pinyinElement = rowElement.querySelector('.lang-pinyin .pinyin');

                        if (chineseElement) {
                            chineseElement.classList.add('chinese-highlight');
                            console.log('‚úÖ Chinese text highlighted');
                        } else {
                            const altChinese = rowElement.querySelector('.chinese-text');
                            if (altChinese) {
                                altChinese.classList.add('chinese-highlight');
                                console.log('‚úÖ Chinese text highlighted (alt selector)');
                            }
                        }

                        if (pinyinElement) {
                            pinyinElement.classList.add('pinyin-highlight');
                            console.log('‚úÖ Pinyin highlighted');
                        } else {
                            const altPinyin = rowElement.querySelector('.pinyin');
                            if (altPinyin) {
                                altPinyin.classList.add('pinyin-highlight');
                                console.log('‚úÖ Pinyin highlighted (alt selector)');
                            }
                        }
                    } else {
                        console.log('‚ÑπÔ∏è Unknown audio type:', audioFilename);
                    }

                    // Ajouter un effet visuel √† la ligne
                    rowElement.classList.add('audio-playing');
                });

                audio.addEventListener('pause', function() {
                    console.log('‚è∏Ô∏è Audio paused');
                    // Retirer tous les surlignements dans cette ligne
                    const allHighlightedElements = rowElement.querySelectorAll(
                        '.phonetic-highlight, .chinese-highlight, .pinyin-highlight, .language-highlight'
                    );
                    allHighlightedElements.forEach(el => {
                        el.classList.remove('phonetic-highlight', 'chinese-highlight', 'pinyin-highlight', 'language-highlight');
                    });
                    rowElement.classList.remove('audio-playing');
                });

                audio.addEventListener('ended', function() {
                    console.log('‚èπÔ∏è Audio ended');
                    // Retirer tous les surlignements dans cette ligne
                    const allHighlightedElements = rowElement.querySelectorAll(
                        '.phonetic-highlight, .chinese-highlight, .pinyin-highlight, .language-highlight'
                    );
                    allHighlightedElements.forEach(el => {
                        el.classList.remove('phonetic-highlight', 'chinese-highlight', 'pinyin-highlight', 'language-highlight');
                    });
                    rowElement.classList.remove('audio-playing');
                });
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Marquer les cat√©gories dans les donn√©es (c√¥t√© client pour l'exemple)
            const rows = document.querySelectorAll('#lexiqueTable tbody tr');
            rows.forEach((row, index) => {
                let category = 'other';
                if (index < 40) category = 'noyau'; // Premiers 40 mots = noyau
                else if (index < 80) category = 'quotidien';
                else if (index < 120) category = 'social';
                else if (index < 160) category = 'travail';
                else category = 'special';
                row.dataset.category = category;
            });

            // Configurer les listeners audio
            setupAudioListeners();

            // Charger les pr√©f√©rences de langues
            loadLanguagePreferences();
        });
    </script>
</body>
</html>
